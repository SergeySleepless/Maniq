//
//  LoginInteractor.swift
//  Maniq
//
//  Created by Ð¡ÐµÑ€Ð³ÐµÐ¹ Ð“Ð°Ð²Ñ€Ð¸Ð»Ð¾Ð² on 02.02.2020.
//  Copyright (c) 2020 Ð¡ÐµÑ€Ð³ÐµÐ¹ Ð“Ð°Ð²Ñ€Ð¸Ð»Ð¾Ð². All rights reserved.
//
//  This file was generated by the ðŸ VIPER generator
//

import Foundation
import FirebaseAuth
import FirebaseFirestore

final class LoginInteractor {
    
    private var vkAuth: VKAuth?
    
    typealias authHandler = (AuthResult, String) -> ()
    
    // MARK: - Private Properties -
    
    private var authHandlerCallback: ((AuthResult, String) -> ())!
    private var password: String!
    
    // MARK: - Private Methods -
    
    /// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° querySnapshot Ð½Ð° nil
    private func check(querySnapshot: QuerySnapshot?) {
        guard !querySnapshot!.documents.isEmpty else {
            authError(result: AuthResult.failure(WrongEnter.loginDataIsWrong))
            return
        }
        getEmail(querySnapshot: querySnapshot!)
    }
    
    /// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° email Ð½Ð° nil
    private func check(email: String?) {
        guard let email = email else {
            self.authError(result: AuthResult.failure(AuthError.userNotFound))
            return
        }
        login(email: email)
    }
    
    /// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ email Ð¿Ð¾ QuerySnapshot
    private func getEmail(querySnapshot: QuerySnapshot) {
        firebaseServices.firestore.getEmail(querySnapshot: querySnapshot) { email in
            self.check(email: email)
        }
    }
    
    /// Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¸Ð½Ð° Ð¿Ð¾ email Ð¸ password
    private func login(email: String) {
        firebaseServices.auth.login(email: email, password: password, handler: self.authHandlerCallback)
    }
    
    /// ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð»Ð¾Ð³Ð¸Ð½Ðµ
    private func authError(result: AuthResult) {
        authHandlerCallback(result, "")
    }
    
    /// ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    private func firestoreError(error: Error, handler: @escaping authHandler) {
        let fError = FirestoreErrorCode(rawValue: error._code)!
        handler(AuthResult.failure(FirestoreError(code: fError)), "")
    }
    
}

// MARK: - Extensions -

extension LoginInteractor: LoginInteractorInterface {
    
    func loginWith(username: String, password: String, handler: @escaping (AuthResult, String) -> ()) {
        self.authHandlerCallback = handler
        self.password = password
        firebaseServices.firestore.getSnapshotFrom(username: username) { snapshot, error in
            if let error = error {
                self.firestoreError(error: error, handler: handler)
                return
            }
            self.check(querySnapshot: snapshot)
        }
    }
    
    func loginWith(phoneNumber: String, password: String, handler: @escaping (AuthResult, String) -> ()) {
        self.authHandlerCallback = handler
        self.password = password
        firebaseServices.firestore.getSnapshotFrom(phoneNumber: phoneNumber) { snapshot, error in
            if let error = error {
                self.firestoreError(error: error, handler: handler)
                return
            }
            self.check(querySnapshot: snapshot)
        }
    }
    
    func vkLogin(delegate: VKAuthDelegate) {
        vkAuth = VKAuth()
        vkAuth?.delegate = delegate
        vkAuth?.wakeUpSession()
    }
    
    func isFilledData(_ loginText: String, _ password: String) -> Error? {
        if loginText.isEmpty && password.isEmpty {
            return NotFilled.allNotFilled
        }
        if loginText.isEmpty {
            return NotFilled.loginNotFilled
        }
        if password.isEmpty {
            return NotFilled.passwordNotFilled
        }
        return nil
    }
    
    func loadUser(email: String, handler: @escaping (Error?) -> ()) {
        firebaseServices.firestore.loadClient(email: email) { (queryDocumentSnapshot, error) in
            if error == nil {
                CurrentState.shared.clientData = ClientData(model: queryDocumentSnapshot!)
            }
            handler(error)
        }
    }
    
}
